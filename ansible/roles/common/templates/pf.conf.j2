#       $FreeBSD: release/9.0.0/share/examples/pf/pf.conf 218854 2011-02-19 14:57:00Z brucec $
#       $OpenBSD: pf.conf,v 1.34 2007/02/24 19:30:59 millert Exp $
#
# See pf.conf(5) and /usr/share/examples/pf for syntax and examples.
# Remember to set net.inet.ip.forwarding=1 and/or net.inet6.ip6.forwarding=1
# in /etc/sysctl.conf if packets are to be forwarded between interfaces.
#
# Required order: options, normalization, queueing, translation, filtering.
# Note: translation rules are first match while filter rules are last match.


################ Macros ###################################

  ### Interfaces ###
    ext_if = "{{ ansible_default_ipv4.interface }}"
    unfiltered  = "{ lo0 }"

  ### Hosts ###
    host_ipv4        = "{{ main_ipv4_address }}"

################ Tables ###################################

  table <sshguard> persist


################ Options ##################################

  ### Misc options ###
    set debug urgent                  # debug messages generated for serious errors
    set require-order yes             # Enable order-checking in this ruleset
    set block-policy drop             # Blocked packets are silently dropped
    set loginterface $ext_if          # Log this interface (if using pflog)
    # When set to if-bound, unbound ICMP packets requesting packet fragmentation are lost (internal mail)
    # set state-policy if-bound
    set state-policy floating
    set fingerprints "/etc/pf.os"     # Fingerprints file for passive operating system fingerprinting set
    set ruleset-optimization basic
    set skip on $unfiltered


  ### Timeout Options ###
    set optimization normal
    # set timeout { tcp.established 360, tcp.closing 60 }


################ Normalization #############################

  # Scrub (normalize) incoming packets
  scrub in  on $ext_if all           fragment reassemble
  scrub out on $ext_if all random-id fragment reassemble


################ Translation ###############################
  no nat on $unfiltered from any to any
  no rdr on $unfiltered from any to any

# Allows nat to specified addresses
nat on $ext_if from any to any      -> $host_ipv4


################ Filtering #################################

  # antispoof quick for lo

  block in quick proto tcp from <sshguard> to any port 22 label "ssh bruteforce"
  pass all
