#       $FreeBSD: release/9.0.0/share/examples/pf/pf.conf 218854 2011-02-19 14:57:00Z brucec $
#       $OpenBSD: pf.conf,v 1.34 2007/02/24 19:30:59 millert Exp $
#
# See pf.conf(5) and /usr/share/examples/pf for syntax and examples.
# Remember to set net.inet.ip.forwarding=1 and/or net.inet6.ip6.forwarding=1
# in /etc/sysctl.conf if packets are to be forwarded between interfaces.
#
# Required order: options, normalization, queueing, translation, filtering.
# Note: translation rules are first match while filter rules are last match.


################ Macros ###################################

{% if provides_jail_host and has_jails %}
  ### Jail Macros ###
    include "/etc/pf/jail_macros.conf"
{% endif %}

  ### Interfaces ###
    ext_if              = "{{ ipv4.interface }}"
    lo_if               = "{{ loopback_if }}"
{% if provides_jail_host and has_jails %}
    jails_if            = "{{ jails_if }}"
{% endif %}
    unfiltered          = "{" $lo_if "}"

  ### Host classes ###
{% if provides_jail_host and has_jails %}
    jailnet             = "{" $jails_if:network "}"
{% endif %}

  ### Hosts ###
    host_ipv4           = "{{ ipv4.address }}"
{% if has_ipv6 %}
    host_ipv6           = "{{ ipv6.address }}"
    host_ipv46          = "{" $host_ipv4 $host_ipv6 "}"
{% endif %}
{% if provides_reverse_proxy %}
    reverse_proxy       = "{{ hostvars[providers['reverse_proxy']].hostname }}"
{% endif %}
{% if provides_mail_server %}
    mail_server       = "{{ hostvars[providers['mail_server']].hostname }}"
{% endif %}

  ### Ports ###
    ssh                 = "{ {{ ansible_ssh_port }} {% if provides_jail_host and has_jails %}" $jail_ssh_ports "{% endif %}}"
    http                = "{ 80 443 }"
    ntp                 = "{ 123 }"
    whois               = "43"
    dns                 = "{ 53 5353 }"
    dhcp                = "{ 67 68 }"
    nfs                 = "{ 111 2049 775 776 777 }"
    samba_udp           = "{ 137 138 }"
    samba_tcp           = "{ 139 445 }"
    mysql               = "3306"
    postgresql          = "5432"
    multicast_dns       = "5353"
    # npp               = "4045"
    github              = "9418"
    services_tcp        = "{ ssh, submission, domain, auth, www, pop3, > 1024 }"
    services_tcp        = "{ ssh, submission, domain, auth }"


################ Tables ###################################
{% if has_sshguard %}

  table <sshguard> persist
{% endif %}


################ Options ##################################

  ### Misc options ###
    set debug urgent                  # debug messages generated for serious errors
    set require-order yes             # Enable order-checking in this ruleset
    set block-policy drop             # Blocked packets are silently dropped
    set loginterface $ext_if          # Log this interface (if using pflog)
    set state-policy floating         # When set to if-bound, unbound ICMP packets requesting packet
                                      # | fragmentation are lost (internal mail) set state-policy if-bound
    set fingerprints "/etc/pf.os"     # Fingerprints file for passive operating system fingerprinting set
    set ruleset-optimization basic
    set skip on $unfiltered


  ### Timeout Options ###
    set optimization normal
    # set timeout { tcp.established 360, tcp.closing 60 }


################ Normalization #############################

  # Scrub (normalize) incoming packets
  scrub in  on $ext_if all           fragment reassemble
  scrub out on $ext_if all random-id fragment reassemble


################ Translation ###############################

  no nat on $unfiltered from any to any
  no rdr on $unfiltered from any to any

  # Allows nat to specified addresses
{% if provides_jail_host and has_jails %}
  nat on $ext_if from $jailnet to any      -> $host_ipv4
{% endif %}

{% if provides_reverse_proxy %}
  # redirect http traffic to reverse-proxy
  rdr on $ext_if proto {tcp udp} to $host_{{ ipv46 }} port $http -> $reverse_proxy
{% endif %}
{% if provides_mail_server %}
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port $http -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 110 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 995 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 143 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 993 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 585 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 587 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 465 -> $mail_server
  rdr on $ext_if proto {tcp udp} to $host_ipv4 port 25 -> $mail_server
{% endif %}
{% if has_sshd and provides_jail_host and has_jails %}
  # redirect ssh to jails
  include "/etc/pf/ssh.rdr.conf"
{% endif %}


################ Filtering #################################

  antispoof log quick for $lo_if

{% if has_sshguard %}
  block in log quick proto tcp from <sshguard> to any port $ssh label "ssh bruteforce"
{% endif %}

  # block all incoming packets but allow ssh, pass all outgoing tcp and udp
  # connections and keep state, logging blocked packets.
  block in log all

  # nmap
  block in log quick on $ext_if inet proto tcp from any to any flags FUP/FUP

  # icmp, ping etc
  pass in on $ext_if proto icmp all
  pass in on $ext_if proto icmp6 all

{% if has_sshd %}
  pass in on $ext_if proto {tcp udp} from any to any port $ssh
{% endif %}

{% if provides_reverse_proxy %}
  # Allows HTTP incoming traffic to host
  pass in on $ext_if proto {tcp udp} from any to $reverse_proxy port $http flags S/SA keep state
{% if provides_jail_host and has_jails %}
  pass on $jails_if proto tcp from $reverse_proxy to $jailnet port $http flags S/SA keep state
  pass in on $jails_if proto udp from $reverse_proxy to $jailnet port $http keep state
  pass on $jails_if proto tcp from $jailnet port $http to $reverse_proxy flags S/SA keep state
  pass in on $jails_if proto udp from $jailnet port $http to $reverse_proxy keep state
{% endif %}
{% endif %}

  # allow anything outbound
  pass out on $ext_if proto { tcp udp icmp icmp6 } all keep state

  # allow anything on loopback interface
  pass on $lo_if all
{% if provides_mail_server %}

  # Allow traffic to and from mail server jail ports
  pass on $ext_if proto {tcp udp} from any to any port { 110 995 143 993 585 587 465 25 445 53 123 }
  pass on $jails_if proto {tcp udp} from any to any port { 110 995 143 993 585 587 465 25 10024 10025 10026 7777 389 3306 6277 20000 11211 }
{% endif %}
{% if open_all_ports %}

  # Temporarily open every port
  pass on $ext_if from any to any
{% if provides_jail_host and has_jails %}
  pass on $jails_if from any to any
{% endif %}
{% endif %}
